// ==========================================================================
// Project:  Ember Data
// Copyright: Â©2011 Living Social Inc. and contributors.
// License:   Licensed under MIT license (see license.js)
// ==========================================================================


(function(a){window.DS=SC.Namespace.create()})({}),function(a){DS.Adapter=SC.Object.extend({commit:function(a,b){b.updated.eachType(function(b,c){this.updateMany(a,b,c.slice())},this),b.created.eachType(function(b,c){this.createMany(a,b,c.slice())},this),b.deleted.eachType(function(b,c){this.deleteMany(a,b,c.slice())},this)},createMany:function(a,b,c){c.forEach(function(c){this.create(a,b,c)},this)},updateMany:function(a,b,c){c.forEach(function(c){this.update(a,b,c)},this)},deleteMany:function(a,b,c){c.forEach(function(c){this.deleteModel(a,b,c)},this)},findMany:function(a,b,c){c.forEach(function(c){this.find(a,b,c)},this)}})}({}),function(a){DS.fixtureAdapter=DS.Adapter.create({find:function(a,b,c){var d=b.FIXTURES;if(d.hasLoaded)return;setTimeout(function(){a.loadMany(b,d),d.hasLoaded=!0},300)},findMany:function(){this.find.apply(this,arguments)}})}({}),function(a){var b=SC.get,c=SC.set;DS.ModelArray=SC.ArrayProxy.extend({type:null,content:null,store:null,init:function(){c(this,"modelCache",Ember.A([])),this._super()},arrayDidChange:function(a,c,d,e){this._super(a,c,d,e);var f=b(this,"modelCache");f.replace(c,0,Array(e))},arrayWillChange:function(a,c,d,e){this._super(a,c,d,e);var f=b(this,"modelCache");f.replace(c,d)},objectAtContent:function(a){var c=b(this,"modelCache"),d=c.objectAt(a);if(!d){var e=b(this,"store"),f=b(this,"content"),g=f.objectAt(a);g!==undefined&&(d=e.findByClientId(b(this,"type"),g),c.replace(a,1,[d]))}return d}}),DS.FilteredModelArray=DS.ModelArray.extend({filterFunction:null,updateFilter:SC.observer(function(){var a=b(this,"store");a.updateModelArrayFilter(this,b(this,"type"),b(this,"filterFunction"))},"filterFunction")}),DS.AdapterPopulatedModelArray=DS.ModelArray.extend({query:null,isLoaded:!1,load:function(a){var d=b(this,"store"),e=b(this,"type"),f=d.loadMany(e,a).clientIds;this.beginPropertyChanges(),c(this,"content",Ember.A(f)),c(this,"isLoaded",!0),this.endPropertyChanges()}})}({}),function(a){var b=SC.get,c=SC.set,d=SC.getPath,e=SC.String.fmt,f=SC.Object.extend({init:function(){this.clear()},clear:function(){this.set("presenceSet",{}),this.set("list",SC.NativeArray.apply([]))},add:function(a){var c=SC.guidFor(a),d=b(this,"presenceSet"),e=b(this,"list");if(c in d)return;d[c]=!0,e.pushObject(a)},remove:function(a){var c=SC.guidFor(a),d=b(this,"presenceSet"),e=b(this,"list");delete d[c],e.removeObject(a)},isEmpty:function(){return d(this,"list.length")===0},forEach:function(a,c){b(this,"list").forEach(function(b){a.call(c,b)})}});DS.Store=SC.Object.extend({init:function(){(!b(DS,"defaultStore")||b(this,"isDefaultStore"))&&c(DS,"defaultStore",this);var a=b(this,"adapter");return typeof a=="string"&&c(this,"adapter",d(this,a)),c(this,"data",[]),c(this,"ids",{}),c(this,"models",[]),c(this,"modelArrays",[]),c(this,"modelArraysByClientId",{}),c(this,"updatedTypes",f.create()),c(this,"createdTypes",f.create()),c(this,"deletedTypes",f.create()),this._super()},modelArraysForClientId:function(a){var c=b(this,"modelArraysByClientId"),d=c[a];return d||(d=c[a]=f.create()),d},adapter:null,clientIdCounter:-1,create:function(a,e){e=e||{};var f=e[d(a,"proto.primaryKey")]||null,g=a.create({data:e||{},store:this});g.adapterDidCreate();var h=this.clientIdToHashMap(a),i=b(this,"models"),j=this.pushHash(e,f,a);return this.updateModelArrays(a,j,e),c(g,"clientId",j),b(this,"models")[j]=g,g},deleteModel:function(a){a.deleteModel()},find:function(a,b,c){if(b===undefined)return this.findMany(a,null,null);if(c!==undefined)return this.findMany(a,b,c);if(SC.typeOf(b)==="object")return this.findQuery(a,b);if(SC.isArray(b))return this.findMany(a,b);var d=this.clientIdForId(a,b);return this.findByClientId(a,d,b)},findByClientId:function(a,c,d){var e,f=b(this,"models"),g=this.clientIdToHashMap(a);return c!==undefined?(e=f[c],e||(e=this.createModel(a,c),e.setData(g[c]||null))):(c=this.pushHash(null,d,a),e=this.createModel(a,c),b(this,"adapter").find(this,a,d)),e},findMany:function(a,c,d){var e=this.idToClientIdMap(a),f=this.clientIdToHashMap(a),g,h=Ember.A([]);return c?(g=[],c.forEach(function(b){var c=e[b];if(c===undefined||f[c]===undefined)c=this.pushHash(null,b,a),g.push(b);h.push(c)},this)):g=null,(g&&b(g,"length")>0||d)&&b(this,"adapter").findMany(this,a,g,d),this.createModelArray(a,h)},findQuery:function(a,c){var d=DS.AdapterPopulatedModelArray.create({type:a,content:Ember.A([]),store:this});return b(this,"adapter").findQuery(this,a,c,d),d},findAll:function(a){var c=DS.ModelArray.create({type:a,content:Ember.A([]),store:this});this.registerModelArray(c,a);var d=b(this,"adapter");return d.findAll&&d.findAll(this,a),c},filter:function(a,b){var c=DS.FilteredModelArray.create({type:a,content:Ember.A([]),store:this,filterFunction:b});return this.registerModelArray(c,a,b),c},hashWasUpdated:function(a,b){var c=this.clientIdToHashMap(a),d=c[b];this.updateModelArrays(a,b,d)},modelBecameDirty:function(a,c){var d=b(this,a+"Types"),e=c.constructor;d.add(e);var f=this.typeMap(e)[a+"Models"];f.add(c)},modelBecameClean:function(a,c){var d=b(this,a+"Types"),e=c.constructor,f=this.typeMap(e)[a+"Models"];f.remove(c),f.isEmpty()&&d.remove(e)},eachDirtyType:function(a,c,d){var e=b(this,a+"Types"),f;e.forEach(function(e){f=this.typeMap(e)[a+"Models"],c.call(d,e,b(f,"list"))},this)},commit:function(){var a=this,c=function(b,c,d){a.eachDirtyType(b,function(a,b){b.forEach(function(a){a.willCommit()}),c.call(d,a,b)})},d={updated:{eachType:function(a,b){c("updated",a,b)}},created:{eachType:function(a,b){c("created",a,b)}},deleted:{eachType:function(a,b){c("deleted",a,b)}}};b(this,"adapter").commit(this,d)},didUpdateModels:function(a){a.forEach(function(a){a.adapterDidUpdate()})},didUpdateModel:function(a){a.adapterDidUpdate()},didDeleteModels:function(a){a.forEach(function(a){a.adapterDidDelete()})},didDeleteModel:function(a){a.adapterDidDelete()},didCreateModels:function(a,c,e){var f,g,h=d(a,"proto.primaryKey"),i=this.idToClientIdMap(a),j=this.clientIdToHashMap(a),k=this.idList(a);for(var l=0,m=b(c,"length");l<m;l++){var n=c[l],o=e[l];f=o[h],g=b(n,"clientId"),j[g]=o,n.set("data",o),i[f]=g,k.push(f),n.adapterDidUpdate()}},didCreateModel:function(a,c){var e=a.constructor,f,g,h=d(e,"proto.primaryKey"),i=this.idToClientIdMap(e),j=this.clientIdToHashMap(e),k=this.idList(e);f=c[h],g=b(a,"clientId"),j[g]=c,i[f]=g,k.push(f),a.adapterDidUpdate()},registerModelArray:function(a,c,d){var e=b(this,"modelArrays"),f=this.idToClientIdMap(c);e.push(a),this.updateModelArrayFilter(a,c,d)},createModelArray:function(a,b){var c=DS.ModelArray.create({type:a,content:b,store:this});return b.forEach(function(a){var b=this.modelArraysForClientId(a);b.add(c)},this),c},updateModelArrayFilter:function(a,b,c){var d=this.clientIdToHashMap(b),e=this.clientIdList(b);for(var f=0,g=e.length;f<g;f++)clientId=e[f],hash=d[clientId],hash&&this.updateModelArray(a,c,b,clientId,hash)},updateModelArrays:function(a,c,d){var e=b(this,"modelArrays");e.forEach(function(e){modelArrayType=b(e,"type"),filter=b(e,"filterFunction");if(a!==modelArrayType)return;this.updateModelArray(e,filter,a,c,d)},this)},updateModelArray:function(a,c,d,e,f){var g;c?g=c(f):g=!0;var h=b(a,"content"),i=h.indexOf(e)!==-1,j=this.modelArraysForClientId(e);g&&!i?(j.add(a),h.pushObject(e)):!g&&i&&(j.remove(a),h.removeObject(e))},removeFromModelArrays:function(a){var c=b(a,"clientId"),d=this.modelArraysForClientId(c);d.forEach(function(a){var d=b(a,"content");d.removeObject(c)})},typeMap:function(a){var c=b(this,"ids"),d=SC.guidFor(a),e=c[d];return e?e:c[d]={idToCid:{},idList:[],cidList:[],cidToHash:{},updatedModels:f.create(),createdModels:f.create(),deletedModels:f.create()}},idToClientIdMap:function(a){return this.typeMap(a).idToCid},idList:function(a){return this.typeMap(a).idList},clientIdList:function(a){return this.typeMap(a).cidList},clientIdToHashMap:function(a){return this.typeMap(a).cidToHash},clientIdForId:function(a,b){return this.typeMap(a).idToCid[b]},idForHash:function(a,b){var c=d(a,"proto.primaryKey");return b[c]},load:function(a,c,e){if(e===undefined){e=c;var f=d(a,"proto.primaryKey");c=e[f]}var g=b(this,"ids"),h=this.clientIdToHashMap(a),i=b(this,"models"),j=this.clientIdForId(a,c);if(j!==undefined){h[j]=e;var k=i[j];k&&(k.willLoadData(),k.setData(e))}else j=this.pushHash(e,c,a);return this.updateModelArrays(a,j,e),{id:c,clientId:j}},loadMany:function(a,c,e){var f=Ember.A([]);if(e===undefined){e=c,c=[];var g=d(a,"proto.primaryKey");c=e.map(function(a){return a[g]})}for(var h=0,i=b(c,"length");h<i;h++){var j=this.load(a,c[h],e[h]);f.pushObject(j.clientId)}return{clientIds:f,ids:c}},pushHash:function(a,b,c){var d=this.idToClientIdMap(c),e=this.clientIdList(c),f=this.idList(c),g=this.clientIdToHashMap(c),h=this.incrementProperty("clientIdCounter");return g[h]=a,b&&(d[b]=h,f.push(b)),e.push(h),h},createModel:function(a,d){var e;return b(this,"models")[d]=e=a.create({store:this,clientId:d}),c(e,"clientId",d),e.loadingData(),e}})}({}),function(a){var b=SC.get,c=SC.set,d=SC.getPath,e=SC.computed(function(a){var c=b(this,"parentState");if(c)return b(c,a)}).property();DS.State=SC.State.extend({isLoaded:e,isDirty:e,isSaving:e,isDeleted:e,isError:e,isNew:e});var f=function(){throw"You cannot load data into the store when its associated model is in its current state"},g={rootState:SC.State.create({isLoaded:!1,isDirty:!1,isSaving:!1,isDeleted:!1,isError:!1,isNew:!1,willLoadData:f,didCreate:function(a){a.goToState("loaded.created")},empty:DS.State.create({loadingData:function(a){a.goToState("loading")}}),loading:DS.State.create({willLoadData:SC.K,exit:function(a){var c=b(a,"model");c.didLoad()},setData:function(a,c){var d=b(a,"model");d.beginPropertyChanges(),d.set("data",c),c!==null&&a.goToState("loaded"),d.endPropertyChanges()}}),loaded:DS.State.create({isLoaded:!0,willLoadData:SC.K,setProperty:function(a,c){var d=c.key,e=c.value,f=b(a,"model"),g=f.constructor,h=b(f,"store"),i=b(f,"data");i[d]=e,h&&h.hashWasUpdated(g,b(f,"clientId")),a.goToState("updated")},"delete":function(a){a.goToState("deleted")},created:DS.State.create({isNew:!0,isDirty:!0,enter:function(a){var c=b(a,"model"),d=b(c,"store");d&&d.modelBecameDirty("created",c)},exit:function(a){var c=b(a,"model"),d=b(c,"store");c.didCreate(),d&&d.modelBecameClean("created",c)},setProperty:function(a,c){var d=c.key,e=c.value,f=b(a,"model"),g=f.constructor,h=b(f,"store"),i=b(f,"data");i[d]=e,h&&h.hashWasUpdated(g,b(f,"clientId"))},willCommit:function(a){a.goToState("saving")},saving:DS.State.create({isSaving:!0,didUpdate:function(a){a.goToState("loaded")}})}),updated:DS.State.create({isDirty:!0,willLoadData:f,enter:function(a){var c=b(a,"model"),d=b(c,"store");d&&d.modelBecameDirty("updated",c)},willCommit:function(a){a.goToState("saving")},exit:function(a){var c=b(a,"model"),d=b(c,"store");c.didUpdate(),d&&d.modelBecameClean("updated",c)},saving:DS.State.create({isSaving:!0,didUpdate:function(a){a.goToState("loaded")}})})}),deleted:DS.State.create({isDeleted:!0,isLoaded:!0,isDirty:!0,willLoadData:f,enter:function(a){var c=b(a,"model"),d=b(c,"store");d&&(d.removeFromModelArrays(c),d.modelBecameDirty("deleted",c))},willCommit:function(a){a.goToState("saving")},saving:DS.State.create({isSaving:!0,didDelete:function(a){a.goToState("saved")},exit:function(a){var c=b(a,"model"),d=b(c,"store");d.modelBecameClean("deleted",c)}}),saved:DS.State.create({isDirty:!1})}),error:DS.State.create({isError:!0})})};DS.StateManager=Ember.StateManager.extend({model:null,initialState:"rootState",states:g});var h=SC.computed(function(a){return b(d(this,"stateManager.currentState"),a)}).property("stateManager.currentState").cacheable();DS.Model=SC.Object.extend({isLoaded:h,isDirty:h,isSaving:h,isDeleted:h,isError:h,isNew:h,clientId:null,primaryKey:"id",data:null,didLoad:Ember.K,didUpdate:Ember.K,didCreate:Ember.K,init:function(){var a=DS.StateManager.create({model:this});c(this,"stateManager",a),a.goToState("empty")},setData:function(a){var c=b(this,"stateManager");c.send("setData",a)},setProperty:function(a,c){var d=b(this,"stateManager");d.send("setProperty",{key:a,value:c})},deleteModel:function(){var a=b(this,"stateManager");a.send("delete")},loadingData:function(){var a=b(this,"stateManager");a.send("loadingData")},willLoadData:function(){var a=b(this,"stateManager");a.send("willLoadData")},willCommit:function(){var a=b(this,"stateManager");a.send("willCommit")},adapterDidUpdate:function(){var a=b(this,"stateManager");a.send("didUpdate")},adapterDidCreate:function(){var a=b(this,"stateManager");a.send("didCreate")},adapterDidDelete:function(){var a=b(this,"stateManager");a.send("didDelete")},unknownProperty:function(a){var c=b(this,"data");if(c)return b(c,a)},setUnknownProperty:function(a,c){var d=b(this,"data");return this.setProperty(a,c),c}}),DS.attr=function(a,c){var d=DS.attr.transforms[a],e=d.from,f=d.to;return SC.computed(function(a,d){var g=b(this,"data");a=c&&c.key?c.key:a;if(d===undefined){if(!g)return;return e(g[a])}return d=f(d),this.setProperty(a,d),d}).property("data")};var i=function(a,c,d,e){var f=d?b(d,e):[];return a.loadMany(c,f).ids},j=function(a,c,d,e){return d?b(d,e):[]};DS.hasMany=function(a,d){var e=d&&d.embedded,f;return findMany=e?i:j,SC.computed(function(d){var e=b(this,"data"),f,g=b(this,"store");f=findMany(g,a,e,d);var h=g.findMany(a,f);return SC.addObserver(this,"data",function(){var e=b(this,"data"),f=findMany(g,a,e,d);g.findMany(a,f);var i=g.idToClientIdMap(a),j=f.map(function(a){return i[a]});c(h,"content",Ember.A(j))}),h}).property().cacheable()},DS.attr.transforms={string:{from:function(a){return String(a)},to:function(a){return String(a)}},integer:{from:function(a){return Number(a)},to:function(a){return Number(a)}},"boolean":{from:function(a){return Boolean(a)},to:function(a){return Boolean(a)}},date:{from:function(a){return new Date(a)},to:function(a){return a.toString()}}}}({}),function(a){}({})
